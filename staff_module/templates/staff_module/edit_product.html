{% extends 'staff_module/staff_base.html' %}

{% block content %}

<div class="container">
    <form method="post" enctype="multipart/form-data" id="productForm" action="{% url 'edit_product' %}">
        {% csrf_token %}
        <div class="mb-3">
            <label for="product_search_input" class="form-label">Search Product by ID:</label>
            <input type="text" id="product_search_input" name="product_search_id" class="form-control" placeholder="Enter product ID" list="dataList_1">
            <datalist id="dataList_1"></datalist>
        </div>

        <div class="mb-3">
            <label for="name" class="form-label">Product Name:</label>
            <input type="text" id="name" name="name" class="form-control">
        </div>

        <div class="mb-3">
            <label for="price" class="form-label">Price:</label>
            <input type="number" id="price" name="price" class="form-control">
        </div>

        <div class="mb-3">
            <label for="category" class="form-label">Category:</label>
            <input type="text" id="category" name="category" class="form-control">
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description:</label>
            <textarea id="description" name="description" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label for="more_info" class="form-label">More Info:</label>
            <textarea id="more_info" name="more_info" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label for="image" class="form-label">Image:</label>
            <input type="file" id="image" name="image" class="form-control">
            <div id="imageContainer" class="mt-3">
                <img id="imagePreview" src="" alt="Product Image" style="max-height: 150px; display: none;">
            </div>
        </div>

        <div class="mb-3">
            <label for="is_sale" class="form-label">On Sale:</label>
            <input type="checkbox" id="is_sale" name="is_sale" class="form-check-input">
        </div>

        <div class="mb-3">
            <label for="sale_price" class="form-label">Sale Price:</label>
            <input type="number" id="sale_price" name="sale_price" class="form-control">
        </div>

        <button type="submit" class="btn btn-primary mt-3">Update Product</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js" crossorigin="anonymous"></script>

<script>
    $(document).ready(function () {
        var productSearchInput = $('#product_search_input');
        var form = $('#productForm');

        // Live search for products by ID
        productSearchInput.on('input', function () {
            var searchValue = this.value.trim();
            if (searchValue.length > 0) {
                $.get('{% url "search_product_list" %}', { search_value: searchValue }, function (data) {
                    var resultsDiv = $('#dataList_1');
                    resultsDiv.empty(); // Clear previous options
                    if (data.length > 0) {
                        data.forEach(function (product) {
                            resultsDiv.append(`<option value="${product.id}">${product.id} - ${product.name}</option>`);
                        });
                    } else {
                        resultsDiv.append('<option value="">No matching products</option>');
                    }
                }).always(function () {
                    productSearchInput.focus();
                });
            } else {
                $('#dataList_1').empty(); // Clear the datalist if input is empty
            }
        });

        // Fill form when a product is selected
        productSearchInput.on('input', function () {
            var searchValue = $(this).val().trim();
            if (searchValue.length > 0) {
                $.ajax({
                    url: '{% url "get_product" %}',
                    data: { search_value: searchValue },
                    method: 'GET',
                    success: function (data) {
                        if (data) {
                            form.find('[name="name"]').val(data.name);
                            form.find('[name="price"]').val(data.price);
                            form.find('[name="category"]').val(data.category);
                            form.find('[name="description"]').val(data.description);
                            form.find('[name="more_info"]').val(data.more_info);
                            form.find('[name="is_sale"]').prop('checked', data.is_sale);
                            form.find('[name="sale_price"]').val(data.sale_price);

                            // Update image preview
                            if (data.image) {
                                $('#imagePreview').attr('src', data.image).show();
                            } else {
                                $('#imagePreview').hide();
                            }

                        } else {
                            alert('No product found.');
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Failed to fetch product data. Please try again.');
                        console.error('Error:', error);
                    }
                });
            }
        });

        // Handle form submission
        form.on('submit', function (e) {
            e.preventDefault(); // Prevent the default form submission

            var updatedData = {}; // Object to hold only updated fields
            form.serializeArray().forEach(function (field) {
                var value = field.value.trim();
                if (value) {
                    updatedData[field.name] = value;
                }
            });

            $.ajax({
                url: '{% url "edit_product" %}',
                method: 'POST',
                data: updatedData,
                success: function (response) {
                    if (response.success) {
                        alert('Product updated successfully!');
                        // Optionally, redirect to another page or reset the form
                    } else {
                        alert('Failed to update product.');
                    }
                },
                error: function (xhr, status, error) {
                    alert('Error occurred while updating product. Please try again.');
                    console.error('Error:', error);
                }
            });
        });
    });
</script>


{% endblock %}
