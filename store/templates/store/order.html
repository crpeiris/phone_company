{% extends 'store/base.html' %} 
{% load store_formula %}
{% block content %}
</br>
<div class = "row justify-content-center" >
<table class = "table table-success padding: 0.5rem 0.5rem " style="width: 75%;">
    <tr>
        <th>Product</th>
        <th>No of units</th>
        <th>Unit price</th>
        <th>Unit Total</th>
        <th>Image</th>
    {% for item in order_items %}
    <tr>
        <div> 
            <td>{{ item.product.name }}</td>
            <td>{{ item.quantity }}</td>
            <td class="text-end">${{ item.product.sale_price }}</td>
            <td class="text-end">${{ item.product.sale_price|multiply:item.quantity|floatformat:2 }}</td>
            <td style="text-align: center;" ><img style="width: 50px;" src="{{ item.product.image.url}}" alt="..." /></td>
            </td>
        </div>
    </tr>
    {% empty %}
        <h3 class = "row justify-content-center" >Your order is empty.</h3>
    {% endfor %}

    </div>
    <tr>
        <td></td>
        <td> Total Price </td>
        <td class="text-end"> ${{ total_price }} </td>
        <td> <form method="POST" id="payment-form">
                {% csrf_token %}
                <button id="checkout-button" class="btn btn-outline-dark mt-auto">Go to Payment</button>
            </form>
        </td>
        <td> <a class="btn btn-outline-dark mt-auto" href="{% url 'delete_order' orderid %}">Delete Order</a></td>
        <td></td>
    </tr>
</table> 
</br>
</br>

<script src="https://js.stripe.com/v3/"></script>

<script>
    const stripe = Stripe('{{ stripe_publishable_key }}'); // Pass the publishable key

    document.getElementById('checkout-button').addEventListener('click', function (event) {
        event.preventDefault();  // Prevent the form from submitting normally

        // Get CSRF token from the form input field
        const csrfToken = document.querySelector('form input[name="csrfmiddlewaretoken"]').value;

        fetch("{% url 'create_checkout_session' orderid %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken // Add the CSRF token to the headers
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                stripe.redirectToCheckout({ sessionId: data.id });
            } else {
                console.error(data.error);
            }
        })
        .catch((error) => console.error('Error:', error));
    });
</script>

{% endblock %}
